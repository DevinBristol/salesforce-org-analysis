/**
 * Created by BENJAMIN on 1/17/2025.
 */

public with sharing class SFMapsAPI {
    public static final Set<String> mailingOnlyTypes =new Set<String>{
            'APT','STE','UNIT','LOT','#','PO BOX','TRLR','DRWY','BLDG','FLR','ROOM','RM',
            'BOX','OFC','SPC','UPPR','LOWR','BSMT','REAR','FRNT','RM','SIDE','SLIP','STOP'
    };
    public static List<String> allTopics=new List<String>{'propertyaddressfull','propertyaddresszip','propertyaddresscity', 'propertylatitude', 'propertylongitude',
            'partyowner1namefull','partyowner2namefull','contactownermailaddressfull','contactownermailaddresscity','statusowneroccupiedflag','construction','structurestyle','legalsubdivision','situscounty',
            'parcelnumberformatted','parcelnumberraw','foundation','roofmaterial','roomscount','bathcount','bedroomscount','storiescount','unitscount','buildingscount','areabuilding',
            'areagross','arealotsf','fireplacecount','ownertypedescription1','ownertypedescription2','currentfirstpositionmortgagetype','currentsecondpositionmortgagetype',
            'availableequity','ltv','currentfirstpositionopenloaninterestrate','ownershipvestingrelationcode','deedlastsaledate',
            'taxyearassessed','taxassessedvaluetotal','taxassessedvalueland','taxassessedvalueimprovements','previousassessedvalue','taxbilledamount','taxmarketvalueland',
            'taxmarketvalueimprovements','taxmarketvaluetotal','taxfiscalyear','yearbuilt','yearbuilteffective','propertyjurisdictionname','deedlastsaleprice','exterior1code',
            'propertyjurisdictionname','propertyusestandardized','currentsecondpositionopenloaninterestrate','propertyusegroup','hvacheatingfuel','hvacheatingdetail','hvaccoolingdetail','parkinggarage'
    };
    public static String source;
    public static String streetTopic;
    public static String cityTopic;
    public static Boolean isRouteSplitting;
    public static String badChars;
    public List<Property__c> props{get;set;}
    public static List<Integer> geographicIds=new List<Integer>();
    public List<String> topics = new List<String>();
    public SfMapsRetriever sfmr{get;set;}
    public List<Property__c> insertProps{get;set;} //like LANDLORDS.
    // namematch score=0,AND*OR:(propertyaddressfull!=contactownermailaddressfull, ownertypedescription1!='INDIVIDUAL',propertyusetype!='Residential%',unitscount>1 or null,statusowneroccupiedflag=FALSE)
    public static void setInitials(String streetTpc,String cityTpc,String src,Boolean routeSplit,String badCharacters){
        source=src;
        cityTopic=cityTpc;
        streetTopic=streetTpc;
        isRouteSplitting=routeSplit;
        badChars=badCharacters;
    }//  â†™â»â»â»â»CONSTRUCTORâ»â»#1â»-â½â€—(sets up static class)//
    public SFMapsAPI(String source,String streetTopic,String cityTopic,Boolean isRouteSplitting,String badChars){
        setInitials(streetTopic,cityTopic,source,isRouteSplitting,badChars);
        this.sfmr = new SfMapsRetriever(source,streetTopic,cityTopic,isRouteSplitting,badChars); //sfmr constructor #1 Â»Â»â€”â€“â€”â†’> INITIALIZER
        System.debug('\rSfmAPI(c1):ENDING:(Success. SFMapsAPI & SFMapsRetriever static variables initialized; SfmAPI & sfmr1 instantiated)...\r\t\tsource:{SFMapsAPI='+SFMapsAPI.source+'; SfMapsRetriever='+SfMapsRetriever.file_id+'\r\t\tstreetTopic:{SFMapsAPI='+SFMapsAPI.streetTopic+'; SfMapsRetriever='+SfMapsRetriever.streetTopic+'}\r\t\tcityTopic:{SFMapsAPI='+SFMapsAPI.cityTopic+'; SfMapsRetriever='+SfMapsRetriever.cityTopic+'}\r\t\tbadChars:{SFMapsAPI='+SFMapsAPI.badChars+'; SfMapsRetriever='+SfMapsRetriever.badChars+'}\r\t\tisRouteSplitting:{SFMapsAPI='+SFMapsAPI.isRouteSplitting+'; SfMapsRetriever='+SfMapsRetriever.isRouteSplitting+'}');
    }//  â†™â»â»â»â»CONSTRUCTORâ»â»#2â»-â½â€—(searches for geoIds)//
    public SFMapsAPI(List<Property__c> props) {
        this.props = props;
        System.debug('\rSfmAPI(c2): Starting with '+this.props.size()+' props.');
        SfMapsRetriever.makeFilterMaps(this.props);
        makeGeoIdRequests(this.props); //constructor #2 Â»Â»â€”â€“â€”â†’> GEO IDS
        System.debug('\rSfmAPI(c2): Ending with '+this.props.size()+',\r\t\t\t\t\t\t'+geographicIds.size()+' GeographicIds \r\t\t\t\t['+geographicIds+']');
    }//  â†™â»â»â»â»CONSTRUCTORâ»â»#3â»-â½â€—(sets up static class)//
    public SFMapsAPI(List<Property__c> props,List<String>inTopics){
        this.topics = topicsChecked(inTopics);
        this.props=props;
        System.debug('\rSfmAPI(c3): Starting with '+this.props.size()+' props.');
        this.sfmr = new SfMapsRetriever(this.props,this.topics,geographicIds); //constructor #3 Â»Â»â€”â€“â€”â†’> HOSTED DATA
        if(this.sfmr.response!=null&&this.sfmr.response.containsKey('data')){
            Map<Id,Property__c>matchGuideMap=new Map<Id,Property__c>(this.props);
            this.props=this.sfmr.procHostedDataResponse(this.sfmr.response);//            System.debug('SfmAPI c3: sfmr.response:\r'+this.sfmr.response);
            System.debug('SfmAPI(c3): Processing Hosted Data Response:\r foundProps(size='+this.props.size()+')â€”>\r'+JSON.serializePretty(this.props));
            if(this.props.size()>0){ // if foundProps contains anything this runs.
                this.props=this.sfmr.nameMatcher(this.props,matchGuideMap);
                System.debug('\rSfmAPI(c3): Clearing Found Props of Duplicate Ids (namematch):\r nameMatchedProps(size='+this.props.size()+')â€”>\r'+JSON.serializePretty(this.props));
                this.props = removePostCallProblems(this.props);
                System.debug('SfmAPI(c3): Post-Processing Found&Matched Props:\r Final Props(size='+this.props.size()+')â€”>\r'+JSON.serializePretty(this.props));
            }
        }
    }
    public static List<String> topicsChecked(List<String> inTopics){
        Set<String> topicDedupe = new Set<String>{'propertyaddressfull','partyowner1namefull','contactownermailaddressfull'};
        for(String inTopic : inTopics){
            if(allTopics.contains(inTopic)){
                topicDedupe.add(inTopic); }
        }
        return new List<String>(topicDedupe);
    }
    public void makeGeoIdRequests(List<Property__c>props){
        for(String searchKey : SfMapsRetriever.searchMap.keySet()){
            this.sfmr = new SfMapsRetriever(props,searchKey);//constructor #2 List<sfmr>...runs all sfmr Constr2 methods,produces the reqString,sends it,& then response.
            if(this.sfmr.reqString!=null&&this.sfmr.response!=null&&this.sfmr.response.containsKey('data')){
                List<Integer> geoIds = this.sfmr.procGeoIdResponse(this.sfmr.response);
                geographicIds.addAll(geoIds);
                System.debug('sfmApi(c2):makeGeoIdRequests:'+searchKey+'\rgeoIds in response='+geoIds+'\r... TOTAL geographicIds so far (size='+geographicIds.size()+')');
            }
        }
    }
    public List<Property__c> removePostCallProblems (List<Property__c> props){ //these are all matched by keymap so we can assume the streettopic value contained all the address__Street__s shtuf
        this.insertProps = new List<Property__c>();
        List<Property__c> updateProps = new List<Property__c>();
        String mailingOnlyStub;
        for(Property__c p : props){
            Boolean isSubunit=false;
            if(p.propertyaddressfull__c!=null&&p.contactownermailaddressfull__c!=null){
                if(mailingOnlyTypes.contains((((p.contactownermailaddressfull__c.substringAfter(p.propertyaddressfull__c)).trim()).substringBefore(' ')).trim())){
                    mailingOnlyStub = (((p.contactownermailaddressfull__c.substringAfter(p.propertyaddressfull__c)).trim()).substringBefore(' ')).trim();
                    System.debug('p.contactownermailaddressfull__câ€”>'+p.contactownermailaddressfull__c+'!!!('+mailingOnlyStub);
                    isSubunit = mailingOnlyTypes.contains(mailingOnlyStub);
                    if(isSubunit){
                        mailingOnlyStub = mailingOnlyStub+p.contactownermailaddressfull__c.substringAfterLast(' '+mailingOnlyStub+' ');
                    }
                } else if(p.contactownermailaddressfull__c.contains('PO BOX')){ mailingOnlyStub='PO BOX'+p.contactownermailaddressfull__c.substringAfterLast('PO BOX');
                }
            } else if(p.contactownermailaddressfull__c!=null&&mailingOnlyTypes.contains(((p.contactownermailaddressfull__c.substringBeforeLast(' ')).substringAfterLast(' ')).trim())){
                mailingOnlyStub = ((p.contactownermailaddressfull__c.substringBeforeLast(' ')).substringAfterLast(' ')).trim();
                System.debug('p.contactownermailaddressfull__câ€”>'+p.contactownermailaddressfull__c+'!!!('+mailingOnlyStub+')');
                isSubunit = mailingOnlyTypes.contains(mailingOnlyStub);
                if(isSubunit){
                    mailingOnlyStub = mailingOnlyStub+p.contactownermailaddressfull__c.substringAfterLast(' '+mailingOnlyStub+' ');
                }
            } else if(p.propertyaddressfull__c!=null&&mailingOnlyTypes.contains(((p.propertyaddressfull__c.substringBeforeLast(' ')).substringAfterLast(' ')).trim())){
                mailingOnlyStub = ((p.propertyaddressfull__c.substringBeforeLast(' ')).substringAfterLast(' ')).trim();
                System.debug('p.propertyaddressfull__câ€”>'+p.propertyaddressfull__c+'!!!('+mailingOnlyStub+')'); isSubunit = mailingOnlyTypes.contains(mailingOnlyStub);
                if(isSubunit){ mailingOnlyStub = mailingOnlyStub+p.propertyaddressfull__c.substringAfterLast(' '+mailingOnlyStub+' ');
                }
            }
            if(isSubunit){
                if(p.Mailing_Only_Address__c!=mailingOnlyStub){
                    System.debug('Mailing Only Update for : '+p.Name+'...new Val='+mailingOnlyStub);
                    p.Mailing_Only_Address__c=mailingOnlyStub; //gets hit either way i guess
                    if(subUnitScour(p)){
                        System.debug('snagged a mailing only bitch.'+p.Id+' '+p.contactownermailaddressfull__c);
                        this.insertProps.add(p);
                    }
                }
            } else {updateProps.add(p);}
            updateProps.add(p);
        }
        System.debug('sfmApi(c3): â€“â€”FINALâ€“TALLYâ€“â€”> (UNIQUE UPDATERS:'+new Set<Property__c>(updateProps).size()+' / UPDATERS: '+updateProps.size()+' /  MATCHED: '+props.size()+' )');
        updateProps=new List<Property__c>(new Set<Property__c>(updateProps));
        return updateProps;
    }
    public static Boolean subUnitScour(Property__c p){
        Boolean isInserter=true; //if(isInserter){updateProps.remove(updateProps.indexOf(p));p. insertProps.add(p);// just update mailingOnlyAddress field//mailing_only_addr__c has different value than mailingstub
        String partyOwnerClump;
        if (p.partyowner1namefull__c!=null) {
            partyOwnerClump = p.partyowner1namefull__c;
        }
        if (p.partyowner2namefull__c!=null) {
            partyOwnerClump = partyOwnerClump + '+' + p.partyowner2namefull__c;
        }
        if (partyOwnerClump!=null&&(partyOwnerClump.length()>3)){
            if(partyOwnerClump.contains('[not provided]')){ partyOwnerClump=(partyOwnerClump.remove('[not provided]')).trim();
            }
            if(p.Account_Property_Relationships__r.size()>0){
                for (Account_Property_Relationship__c apr : p.Account_Property_Relationships__r) {
                    if(apr.Account__r.Name.contains(' & ')){
                        if(((apr.Account__r.Name.substringAfter(' ').substringBefore(' & ')).length()>1&&partyOwnerClump.containsIgnoreCase(apr.Account__r.Name.substringAfter(' ').substringBefore(' & ')))||((apr.Account__r.Name.substringAfterLast(' ')).length()>1&&partyOwnerClump.containsIgnoreCase(apr.Account__r.Name.substringAfterLast(' ')))){ isInserter=false;
                        }
                    } else if(apr.Account__r.Name.contains(' ')){
                        if(apr.Account__r.Name.substringAfter(' ').length()>1&&partyOwnerClump.containsIgnoreCase(apr.Account__r.Name.substringAfter(' '))){ isInserter=false;
                        } else if(apr.Account__r.Name.substringBefore(' ').length()>1&&partyOwnerClump.containsIgnoreCase(apr.Account__r.Name.substringAfter(' '))){ isInserter=false;
                        }
                    } else if(apr.Account__r.Name.length()>1&&partyOwnerClump.containsIgnoreCase(apr.Account__r.Name)) { //just contains a wordisInserter=false;
                    }
                }
            } else if (p.Leads__r.size() > 0) {
                for (Lead l : p.Leads__r) {
                    if (partyOwnerClump.containsIgnoreCase(l.LastName)) {
                        isInserter=false;
                    }
                }
            }
        } else { isInserter=false; }//need owner names
        return isInserter;
    }
    public static List<PropertyPirateShip.pirateShipFilter>ScavengePrep(){
        List<PropertyPirateShip.pirateShipFilter>pirateFilters=new List<PropertyPirateShip.pirateShipFilter>();
        return pirateFilters; }
    public static Map<String,Object>Scavenger(List<Property__c>unmatchedProps){
        //return extra markers for stuff we can know about who we're after. Mess around with piratefilters to make them usable for topic filtering as a parameter.
        Map<String,Object>scavengedRes=new Map<String,Object>(); ScavengingPlan(ScavengePrep());
        return scavengedRes; }

    public static void ScavengingPlan(List<PropertyPirateShip.pirateShipFilter>pirateFilters){ }
}
// â†• : êœœêœ›â†–â†â†™â†“â†•â†˜â†’â†— â‡’â†” â‡” â¬Šâ¬‡â¬‹â¬…â¬‰â¬†â¬ˆâ¡Í¢â­°â­¶â­±â­·â­²â­¸â­³â­¹ğŸ¡¸ğŸ¡¼ğŸ¡¹ğŸ¡½ğŸ¡ºğŸ¡¾ğŸ¡»ğŸ¡¿    // <>:   Ë‚Ëƒ,{},[],(),â€¹â€º,Â«ã€ˆã€‰,ã€Šã€‹,â—€â–¶,â—â–· â‰¤â‰¥,â‰ªâ‰«,Ê¿Ê¾Ë“Ë’,â˜œâ˜,âŠ‚âŠƒ,âŠ†âŠ‡,ã€”ã€•,ã€ã€‘
// v^:  vVâ±½,âˆ‡âˆ†,âˆ¨âˆ§,Ë…Ë„,ï¹€ï¸¿,ï¸¾ï¸½,â–½â–³,â–¼â–²,Ë†Ë‡,áµ•áµ”,Ë•Ë”,áµ¥áµ§áµá´§,Û·Û¸,ËËËŠË‹,êˆÎ»Í®  // nu:   Î á´¨,uU,âˆ,ÕÕŒ,âˆ©âˆª,âŒ’,ï¸µï¸¶,ï¸·ï¸¸,ï¸¹ï¸º,ï¸»ï¸¼,ï¹‡ï¹ˆ,á´«
// | :   êŒÇ€Çâã…£Â¦|â€–â”‚â•‘â”ƒâ•ˆ â•‰â€ â€¡Iã…âŠ¥ã…›ã…œâ–’Æ–I!â€¼Çƒêœáµ¢Â¡,\/â„                 // _-:    â€—Ë_ï¹â€•â€’ã…¡â”€â€”â€“-â–¬â”ï¿£â€¾Ë‰Â¨ï¹Š"'â€¦â€¥âºâ»â¼â½â¯
// LJ:  âˆ ,ÕŸï¹‚ï¹„ã€Ë©ã€,â””â”•â”–â”—,âˆŸÕ¬,ÕµÈ·,âŒ¡,ÊŸá´¸á´¶Ê²É¹Éºã…¢,â””â”˜â•˜â•›â•™â•œâ•šâ•           // r7    á„¼á…á„½á…á„¾á…á„¿á…‘,âŒã€Œã€â”Œâ”â”â”âŒ ê„Õ,Ë¥ê€Â¬ï¹ï¹ƒï¿¢,ê­ˆê­‹,Å¿Å•Å—Å™á´¦Ê´Ê³áµ£â· â”Œâ”â•’â••â•“â•–â•”â•—                                                    //    = :   =â•â‰¡ã€“â‰’Ê­Â±Ë–Ã·â¸—êŸ¾â– â–¡â–£ËŒ.:;,ËË‘`Û±ã€ã€ƒâ€œâ€â€›â€™â€Ÿâ€â€˜â€šá¿½á¿¾âˆ¬âˆ«
// * :   â€»â€¢â™©â™ªâ™¬â™­â™£â™¤â™¥â™¨â™§ã€‚â—†â—‡â—ˆâ—‹â—â—â—â—‘â˜…â˜†â˜â˜â™€â™‚â™ â™¡âˆ´Â¤