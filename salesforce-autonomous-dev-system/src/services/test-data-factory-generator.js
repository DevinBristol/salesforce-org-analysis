// src/services/test-data-factory-generator.js - Test Data Factory Generation Service

import { MockFrameworkGenerator } from './mock-framework-generator.js';

/**
 * Generates test data factories and builders for Salesforce SObjects
 */
export class TestDataFactoryGenerator {
    constructor(salesforceManager, logger) {
        this.salesforceManager = salesforceManager;
        this.logger = logger;
        this.mockGenerator = new MockFrameworkGenerator(logger);
    }

    /**
     * Generates a test data builder for a specific SObject
     * @param {string} sobjectType - Name of the SObject (e.g., 'Account', 'Opportunity')
     * @returns {Object} {className, code, metadata}
     */
    async generateFactoryForSObject(sobjectType) {
        try {
            this.logger.info(`Generating test data factory for ${sobjectType}...`);

            // Get SObject schema from Salesforce
            const schema = await this.salesforceManager.getObjectSchema(sobjectType);

            // Extract relevant fields
            const fields = this.extractRelevantFields(schema);

            // Generate builder class
            const className = `${sobjectType}Builder`;
            const code = this.mockGenerator.generateTestDataBuilder(sobjectType, fields);

            // Generate metadata XML
            const metadata = this.generateMetadataXml(className);

            return {
                className,
                code,
                metadata,
                sobjectType,
                fieldCount: fields.length
            };
        } catch (error) {
            this.logger.error(`Failed to generate factory for ${sobjectType}:`, error);
            throw error;
        }
    }

    /**
     * Generates factories for multiple SObjects
     * @param {Array<string>} sobjectTypes - List of SObject names
     * @returns {Array} Array of factory generation results
     */
    async generateFactoriesForMultipleSObjects(sobjectTypes) {
        const results = [];

        for (const sobjectType of sobjectTypes) {
            try {
                const factory = await this.generateFactoryForSObject(sobjectType);
                results.push({
                    success: true,
                    sobjectType,
                    factory
                });
            } catch (error) {
                results.push({
                    success: false,
                    sobjectType,
                    error: error.message
                });
            }
        }

        return results;
    }

    /**
     * Generates a universal test data factory that handles common SObjects
     * @returns {Object} {className, code, metadata}
     */
    generateUniversalFactory() {
        const className = 'TestDataFactory';
        const code = `/**
 * Universal Test Data Factory
 * Provides builder methods for common Salesforce objects
 * Generated by Salesforce Autonomous Dev System
 */
@isTest
public class TestDataFactory {

    /**
     * Creates Account builder
     * @return AccountBuilder instance
     */
    public static AccountBuilder createAccount() {
        return new AccountBuilder();
    }

    /**
     * Creates Contact builder
     * @return ContactBuilder instance
     */
    public static ContactBuilder createContact() {
        return new ContactBuilder();
    }

    /**
     * Creates Opportunity builder
     * @return OpportunityBuilder instance
     */
    public static OpportunityBuilder createOpportunity() {
        return new OpportunityBuilder();
    }

    /**
     * Creates Lead builder
     * @return LeadBuilder instance
     */
    public static LeadBuilder createLead() {
        return new LeadBuilder();
    }

    /**
     * Creates Case builder
     * @return CaseBuilder instance
     */
    public static CaseBuilder createCase() {
        return new CaseBuilder();
    }

    /**
     * Creates User builder (for testing with different user contexts)
     * @return UserBuilder instance
     */
    public static UserBuilder createUser() {
        return new UserBuilder();
    }

    /**
     * Helper method to create and insert a list of records in bulk
     * @param records List of SObjects to insert
     * @return Inserted records with Ids
     */
    public static List<SObject> createRecords(List<SObject> records) {
        insert records;
        return records;
    }

    /**
     * Helper method to create test user with specific profile
     * @param profileName Name of profile to assign
     * @param alias Unique alias for the user
     * @return Created User record
     */
    public static User createTestUser(String profileName, String alias) {
        Profile profile = [SELECT Id FROM Profile WHERE Name = :profileName LIMIT 1];

        User testUser = new User(
            Alias = alias,
            Email = alias + '@test.com',
            EmailEncodingKey = 'UTF-8',
            LastName = 'Test User ' + alias,
            LanguageLocaleKey = 'en_US',
            LocaleSidKey = 'en_US',
            ProfileId = profile.Id,
            TimeZoneSidKey = 'America/Los_Angeles',
            UserName = alias + '@test' + System.currentTimeMillis() + '.com'
        );

        insert testUser;
        return testUser;
    }

    /**
     * Creates a test RecordType for an SObject
     * @param sobjectType API name of the SObject
     * @param recordTypeName Name of the record type
     * @return RecordType Id
     */
    public static Id getRecordTypeId(String sobjectType, String recordTypeName) {
        return Schema.getGlobalDescribe()
            .get(sobjectType)
            .getDescribe()
            .getRecordTypeInfosByName()
            .get(recordTypeName)
            .getRecordTypeId();
    }
}`;

        const metadata = this.generateMetadataXml(className);

        return { className, code, metadata };
    }

    /**
     * Extracts relevant fields from SObject schema for test data builder
     * @param {Object} schema - SObject describe result from Salesforce
     * @returns {Array} Array of field definitions
     */
    extractRelevantFields(schema) {
        const fields = [];

        for (const field of schema.fields) {
            // Skip system fields and relationships
            if (this.shouldIncludeField(field)) {
                fields.push({
                    name: field.name,
                    type: this.mapSalesforceTypeToApex(field.type),
                    required: !field.nillable && field.createable,
                    label: field.label,
                    length: field.length,
                    isPicklist: field.type === 'picklist',
                    picklistValues: field.picklistValues || []
                });
            }
        }

        return fields;
    }

    /**
     * Determines if a field should be included in the builder
     * @param {Object} field - Field describe result
     * @returns {boolean} True if field should be included
     */
    shouldIncludeField(field) {
        // Exclude system fields
        const systemFields = [
            'Id', 'CreatedDate', 'CreatedById', 'LastModifiedDate',
            'LastModifiedById', 'SystemModstamp', 'IsDeleted'
        ];

        if (systemFields.includes(field.name)) {
            return false;
        }

        // Exclude read-only fields
        if (!field.createable && !field.updateable) {
            return false;
        }

        // Exclude formula fields
        if (field.calculated) {
            return false;
        }

        // Exclude reference fields (lookup/master-detail handled separately)
        if (field.type === 'reference' && field.name.endsWith('Id')) {
            return false;
        }

        return true;
    }

    /**
     * Maps Salesforce field type to Apex data type
     * @param {string} salesforceType - Salesforce field type
     * @returns {string} Apex data type
     */
    mapSalesforceTypeToApex(salesforceType) {
        const typeMap = {
            'string': 'String',
            'textarea': 'String',
            'email': 'String',
            'phone': 'String',
            'url': 'String',
            'picklist': 'String',
            'multipicklist': 'String',
            'int': 'Integer',
            'double': 'Decimal',
            'currency': 'Decimal',
            'percent': 'Decimal',
            'boolean': 'Boolean',
            'date': 'Date',
            'datetime': 'DateTime',
            'time': 'Time',
            'reference': 'Id',
            'id': 'Id'
        };

        return typeMap[salesforceType.toLowerCase()] || 'String';
    }

    /**
     * Analyzes test class to identify which SObjects need factories
     * @param {string} testClassContent - Test class source code
     * @returns {Array<string>} List of SObject types used in tests
     */
    identifySObjectsInTestClass(testClassContent) {
        const sobjects = new Set();

        // Look for common SObject patterns
        const patterns = [
            /new\s+(\w+)\s*\(/g,                    // new Account()
            /\[\s*SELECT\s+.*?\s+FROM\s+(\w+)/gi,   // SELECT ... FROM Account
            /insert\s+(\w+)/gi,                     // insert account
            /update\s+(\w+)/gi,                     // update account
            /List<(\w+)>/g,                         // List<Account>
            /Map<\w+,\s*(\w+)>/g                    // Map<Id, Account>
        ];

        for (const pattern of patterns) {
            let match;
            while ((match = pattern.exec(testClassContent)) !== null) {
                const potentialSObject = match[1];
                // Filter out common Apex types
                if (this.isPotentialCustomSObject(potentialSObject)) {
                    sobjects.add(potentialSObject);
                }
            }
        }

        return Array.from(sobjects);
    }

    /**
     * Checks if a type name is likely a custom SObject
     * @param {string} typeName - Type name to check
     * @returns {boolean} True if likely a custom SObject
     */
    isPotentialCustomSObject(typeName) {
        // Exclude common Apex types
        const apexTypes = [
            'String', 'Integer', 'Long', 'Decimal', 'Double', 'Boolean',
            'Date', 'DateTime', 'Time', 'Blob', 'Id', 'Object',
            'List', 'Set', 'Map', 'System', 'Test', 'Database',
            'Schema', 'Exception', 'HttpRequest', 'HttpResponse'
        ];

        if (apexTypes.includes(typeName)) {
            return false;
        }

        // Standard objects and custom objects
        const standardObjects = [
            'Account', 'Contact', 'Lead', 'Opportunity', 'Case',
            'Task', 'Event', 'User', 'Profile', 'PermissionSet',
            'RecordType', 'ContentVersion', 'ContentDocument'
        ];

        // Include standard objects and anything ending with __c (custom object)
        return standardObjects.includes(typeName) || typeName.endsWith('__c');
    }

    /**
     * Generates metadata XML for the factory class
     * @param {string} className - Name of the factory class
     * @returns {string} Metadata XML content
     */
    generateMetadataXml(className) {
        return `<?xml version="1.0" encoding="UTF-8"?>
<ApexClass xmlns="http://soap.sforce.com/2006/04/metadata">
    <apiVersion>${process.env.SF_API_VERSION || '60.0'}</apiVersion>
    <status>Active</status>
</ApexClass>`;
    }

    /**
     * Generates a comprehensive test data setup helper
     * @returns {Object} {className, code, metadata}
     */
    generateTestDataSetupHelper() {
        const className = 'TestDataSetup';
        const code = `/**
 * Test Data Setup Helper
 * Provides common test data setup scenarios
 * Generated by Salesforce Autonomous Dev System
 */
@isTest
public class TestDataSetup {

    /**
     * Creates a complete Account hierarchy with Contacts and Opportunities
     * @param accountCount Number of accounts to create
     * @return Map with created records by type
     */
    public static Map<String, List<SObject>> createAccountHierarchy(Integer accountCount) {
        Map<String, List<SObject>> results = new Map<String, List<SObject>>();

        // Create Accounts
        List<Account> accounts = new List<Account>();
        for (Integer i = 0; i < accountCount; i++) {
            accounts.add(new Account(
                Name = 'Test Account ' + i,
                Industry = 'Technology',
                Type = 'Customer',
                AnnualRevenue = 1000000
            ));
        }
        insert accounts;
        results.put('Account', accounts);

        // Create Contacts for each Account
        List<Contact> contacts = new List<Contact>();
        for (Account acc : accounts) {
            contacts.add(new Contact(
                AccountId = acc.Id,
                FirstName = 'Test',
                LastName = 'Contact ' + acc.Name,
                Email = 'test' + acc.Id + '@example.com'
            ));
        }
        insert contacts;
        results.put('Contact', contacts);

        // Create Opportunities for each Account
        List<Opportunity> opportunities = new List<Opportunity>();
        for (Account acc : accounts) {
            opportunities.add(new Opportunity(
                AccountId = acc.Id,
                Name = 'Test Opp ' + acc.Name,
                StageName = 'Prospecting',
                CloseDate = Date.today().addDays(30),
                Amount = 50000
            ));
        }
        insert opportunities;
        results.put('Opportunity', opportunities);

        return results;
    }

    /**
     * Creates bulk test data for governor limit testing
     * @param sobjectType Type of SObject to create
     * @param recordCount Number of records (default 200 for bulk testing)
     * @return List of created records
     */
    public static List<SObject> createBulkTestData(String sobjectType, Integer recordCount) {
        List<SObject> records = new List<SObject>();

        if (sobjectType == 'Account') {
            for (Integer i = 0; i < recordCount; i++) {
                records.add(new Account(
                    Name = 'Bulk Test Account ' + i,
                    Industry = 'Technology'
                ));
            }
        } else if (sobjectType == 'Contact') {
            // Need a parent account for contacts
            Account acc = new Account(Name = 'Bulk Test Account');
            insert acc;

            for (Integer i = 0; i < recordCount; i++) {
                records.add(new Contact(
                    AccountId = acc.Id,
                    FirstName = 'Bulk',
                    LastName = 'Contact ' + i,
                    Email = 'bulktest' + i + '@example.com'
                ));
            }
        } else if (sobjectType == 'Opportunity') {
            // Need a parent account for opportunities
            Account acc = new Account(Name = 'Bulk Test Account');
            insert acc;

            for (Integer i = 0; i < recordCount; i++) {
                records.add(new Opportunity(
                    AccountId = acc.Id,
                    Name = 'Bulk Opp ' + i,
                    StageName = 'Prospecting',
                    CloseDate = Date.today().addDays(30)
                ));
            }
        }

        if (!records.isEmpty()) {
            insert records;
        }

        return records;
    }

    /**
     * Creates test data with required relationships
     * Useful for testing trigger handlers
     * @return Map of related records
     */
    public static Map<String, SObject> createRelatedRecords() {
        Map<String, SObject> relatedRecords = new Map<String, SObject>();

        // Create Account
        Account acc = new Account(
            Name = 'Test Account',
            Industry = 'Technology'
        );
        insert acc;
        relatedRecords.put('Account', acc);

        // Create Contact
        Contact con = new Contact(
            AccountId = acc.Id,
            FirstName = 'Test',
            LastName = 'Contact',
            Email = 'test@example.com'
        );
        insert con;
        relatedRecords.put('Contact', con);

        // Create Opportunity
        Opportunity opp = new Opportunity(
            AccountId = acc.Id,
            Name = 'Test Opportunity',
            StageName = 'Prospecting',
            CloseDate = Date.today().addDays(30)
        );
        insert opp;
        relatedRecords.put('Opportunity', opp);

        return relatedRecords;
    }

    /**
     * Sets up test user with specific permission set
     * @param permissionSetName Name of permission set to assign
     * @return Created test user
     */
    public static User setupTestUserWithPermissions(String permissionSetName) {
        Profile standardProfile = [SELECT Id FROM Profile WHERE Name = 'Standard User' LIMIT 1];

        User testUser = new User(
            Alias = 'tuser',
            Email = 'testuser@example.com',
            EmailEncodingKey = 'UTF-8',
            LastName = 'Test User',
            LanguageLocaleKey = 'en_US',
            LocaleSidKey = 'en_US',
            ProfileId = standardProfile.Id,
            TimeZoneSidKey = 'America/Los_Angeles',
            UserName = 'testuser' + System.currentTimeMillis() + '@test.com'
        );
        insert testUser;

        // Assign permission set
        PermissionSet ps = [SELECT Id FROM PermissionSet WHERE Name = :permissionSetName LIMIT 1];
        insert new PermissionSetAssignment(
            AssigneeId = testUser.Id,
            PermissionSetId = ps.Id
        );

        return testUser;
    }
}`;

        const metadata = this.generateMetadataXml(className);

        return { className, code, metadata };
    }
}
